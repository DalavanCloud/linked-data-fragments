<html>
	<head>
		<title>JSON-LD to SPO</title>
		<meta charset="UTF-8"/>
		<script src="jquery.js"></script>
		<!-- stuff below needs to go into CouchDB views -->
		<!-- <script src="language.js"></script> -->
		<style>
		td { border: 1px solid red; }
		</style>
	</head>
<body>

<h1>ORCID work DOI to author role</h1>

<div>
	<div style="width:100%;height:auto;">
		<h2>JSON</h2>
		
<!--

{
  "message-format": "application/vnd.citationstyles.csl+json",
  "message": {
    "id": "EWART_2015",
    "type": "article-journal",
    "author": [
      {
        "family": "EWART",
        "given": "A.",
        "literal": "A. EWART"
      },
      {
        "family": "POPPLE",
        "given": "L.W.",
        "literal": "L.W. POPPLE",
        "ORCID": "0000-0001-8630-3114"
      },
      {
        "family": "MARSHALL",
        "given": "D.C.",
        "literal": "D.C. MARSHALL"
      }
    ],
    "event-date": {
      "date-parts": [
        [
          2015,
          8
        ]
      ]
    },
    "issued": {
      "date-parts": [
        [
          2015,
          8
        ]
      ]
    },
    "collection-title": "Zootaxa",
    "container-title": "Zootaxa",
    "DOI": "10.11646/zootaxa.4001.1.1",
    "issue": "1",
    "number": "1",
    "number-of-pages": "1",
    "page": "1",
    "page-first": "1",
    "publisher": "Magnolia Press",
    "title": "<strong>New species of <em>Simona</em> Moulds, 2012 and <em>Chelapsalta</em> Moulds, 2012 cicadas (Cicadidae: Cicadettinae: Cicadettini) from Australia: comparative morphology, songs, behaviour and distributions</strong>",
    "URL": "https://doi.org/10.11646%2Fzootaxa.4001.1.1",
    "volume": "4001"
  }
}

-->		
		
		
		
			<!-- JSON for data object goes below -->
			<textarea id="json" style="width:100%;background-color:#224FBC;color:#FFFF66;" rows="20">{
  "_id": "https://biostor.org/reference/246525",
  "_rev": "2-7c919c6ccc9cc56a492bdee6213a5e86",
  "message-timestamp": "2019-01-08T15:04:32+00:00",
  "message-modified": "2019-01-08T15:04:32+00:00",
  "message-format": "application/ld+json",
  "message-source": "http://localhost/~rpage/biostor/api.php?id=biostor/246525&format=jsonld",
  "message": {
    "@context": {
      "@vocab": "http://schema.org/",
      "sameAs": {
        "@id": "http://schema.org/sameAs",
        "@container": "@set"
      },
      "issn": {
        "@id": "http://schema.org/issn",
        "@container": "@set"
      }
    },
    "@graph": [
      {
        "@id": "http://localhost/~rpage/biostor/reference/246525",
        "@type": [
          "ScholarlyArticle",
          "itemList"
        ],
        "creator": [
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#role/1",
            "@type": "Role",
            "creator": {
              "@id": "http://localhost/~rpage/biostor/reference/246525#creator/1",
              "@type": "Person",
              "familyName": "Lin",
              "givenName": "C-W ",
              "name": "C-W Lin"
            },
            "roleName": "1"
          },
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#role/2",
            "@type": "Role",
            "creator": {
              "@id": "http://localhost/~rpage/biostor/reference/246525#creator/2",
              "@type": "Person",
              "familyName": "Thomas",
              "givenName": "D C",
              "name": "D C Thomas"
            },
            "roleName": "2"
          },
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#role/3",
            "@type": "Role",
            "creator": {
              "@id": "http://localhost/~rpage/biostor/reference/246525#creator/3",
              "@type": "Person",
              "familyName": "Ardi",
              "givenName": "W H ",
              "name": "W H Ardi"
            },
            "roleName": "3"
          },
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#role/4",
            "@type": "Role",
            "creator": {
              "@id": "http://localhost/~rpage/biostor/reference/246525#creator/4",
              "@type": "Person",
              "familyName": "Peng",
              "givenName": "C-I",
              "name": "C-I Peng"
            },
            "roleName": "4"
          }
        ],
        "datePublished": "2017-00-00",
        "identifier": [
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#biostor",
            "@type": "PropertyValue",
            "propertyID": "biostor",
            "value": "246525"
          },
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#doi",
            "@type": "PropertyValue",
            "propertyID": "doi",
            "value": "10.26492/gbs69(1).2017-06"
          }
        ],
        "isPartOf": {
          "@id": "http://worldcat.org/issn/0374-7859",
          "issn": [
            "0374-7859"
          ],
          "name": "Gardens' Bulletin Singapore"
        },
        "issueNumber": "1",
        "itemListElement": [
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#listitem_1",
            "@type": "ListItem",
            "item": {
              "@id": "https://biodiversitylibrary.org/page/56622825",
              "@type": "ImageObject"
            },
            "position": "1"
          },
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#listitem_2",
            "@type": "ListItem",
            "item": {
              "@id": "https://biodiversitylibrary.org/page/56622826",
              "@type": "ImageObject"
            },
            "position": "2"
          },
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#listitem_3",
            "@type": "ListItem",
            "item": {
              "@id": "https://biodiversitylibrary.org/page/56622827",
              "@type": "ImageObject"
            },
            "position": "3"
          },
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#listitem_4",
            "@type": "ListItem",
            "item": {
              "@id": "https://biodiversitylibrary.org/page/56622828",
              "@type": "ImageObject"
            },
            "position": "4"
          },
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#listitem_5",
            "@type": "ListItem",
            "item": {
              "@id": "https://biodiversitylibrary.org/page/56622829",
              "@type": "ImageObject"
            },
            "position": "5"
          },
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#listitem_6",
            "@type": "ListItem",
            "item": {
              "@id": "https://biodiversitylibrary.org/page/56622830",
              "@type": "ImageObject"
            },
            "position": "6"
          },
          {
            "@id": "http://localhost/~rpage/biostor/reference/246525#listitem_7",
            "@type": "ListItem",
            "item": {
              "@id": "https://biodiversitylibrary.org/page/56622831",
              "@type": "ImageObject"
            },
            "position": "7"
          }
        ],
        "name": "Begonia ignita (sect. Petermannia, Begoniaceae), a new species with orange flowers from Sulawesi, Indonesia",
        "pageEnd": "95",
        "pageStart": "89",
        "sameAs": [
          "https://biostor.org/reference/246525",
          "https://doi.org/10.26492/gbs69(1).2017-06"
        ],
        "url": "http://localhost/~rpage/biostor/reference/246525",
        "volume": "69"
      }
    ]
  }
}</textarea>
			<br />
			<button onclick="convert()">Convert JSON to JSON-LD</button>
	</div>
	<div style="clear:both;"></div>
	
	<div style="width:100%;">
		<h2>JSON-LD</h2>
		<div id="jsonld" style="width:100%;white-space:pre;background-color:#333;color:white;overflow:auto;"></div>

</div>			
			
		
		
		
<script>
	
//----------------------------------------------------------------------------------------
// START COUCHDB VIEW
var triples = [];

var bnode_count = 0;

//----------------------------------------------------------------------------------------
function bnode() {
	bnode_count++;
	
	return 'b' + bnode_count;
}

//----------------------------------------------------------------------------------------
// http://stackoverflow.com/a/25715455
function isObject(item) {
    return (typeof item === "object" && !Array.isArray(item) && item !== null);
}

//----------------------------------------------------------------------------------------
// http://stackoverflow.com/a/21445415
function uniques(arr) {
    var a = [];
    for (var i = 0, l = arr.length; i < l; i++)
        if (a.indexOf(arr[i]) === -1 && arr[i] !== '')
            a.push(arr[i]);
    return a;
}

//----------------------------------------------------------------------------------------
function detect_language(s) {
    var language = null;
    var matched = 0;
    var parts = [];

    var regexp = [];

    // https://gist.github.com/ryanmcgrath/982242
    regexp['ja'] = /[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g;
    // http://hjzhao.blogspot.co.uk/2015/09/javascript-detect-chinese-character.html
    regexp['zh'] = /[\u4E00-\uFA29]/g;
    // http://stackoverflow.com/questions/32709687/js-check-if-string-contains-only-cyrillic-symbols-and-spaces
    regexp['ru'] = /[\u0400-\u04FF]/g;

    for (var i in regexp) {
        parts = s.match(regexp[i]);

        if (parts != null) {
            if (parts.length > matched) {
                language = i;
                matched = parts.length;
            }
        }
    }

    // require a minimum matching
    if (matched < 2) {
        language = null;
    }

    return language;
}

//----------------------------------------------------------------------------------------
// Store a triple with optional language code
function triple(subject, predicate, object, language) {
    var triple = [];
    
    subject = subject.replace(/</g, '%3C');
    subject = subject.replace(/>/g, '%3E');
    
    triple[0] = subject;
    triple[1] = predicate;

    // Object may be URI or literal
    if (object.match(/^(http|urn|_:)/)) {
    
    	object = object.replace(/</g, '%3C');
    	object = object.replace(/>/g, '%3E');    
    
        triple[2] = object;
    } else {
        var literal = object;
        if (typeof language === 'undefined') {} else {
            literal += '@' + language;
        }
        triple[2] = literal;
    }

    return triple;
}

//----------------------------------------------------------------------------------------
function property_to_uri(context, property) {
    var uri = property;
    
	if (context) {
		var m = property.match(/([a-z]+):([a-z]+)/i);
		if (m) {
			if (context[m[1]]) {
				uri = context[m[1]] + m[2];
			}
		} else {
			if (context['@vocab']) {
				uri = context['@vocab'] + property;
			} else {
				if (typeof context === 'string') {
					uri = context + property;
				}
			}
		}
	}

    return uri;
}

//----------------------------------------------------------------------------------------
function subtree(context, root, subject) {

    for (var i in root) {

        // Simple literal
        if (typeof root[i] === 'string') {
            switch (i) {
                case '@context':
                case '@id':
                    break;

                case '@type':                
                    // triples.push(triple(subject, 'http://www.w3.org/1999/02/22-rdf-syntax-ns#type', property_to_uri(context, root[i])));
                    break;

                default:
                	
                    // simple literal
                    triples.push(
                        triple(
                            subject,
                            property_to_uri(context, i),
                            '"' + root[i].replace(/"/g, '\\"') + '"'
                        )
                    );
                    
                    break;
            }
        }

        if (isObject(root[i])) {
            if (root[i]['@value'] && root[i]['@language']) {
                // literal with language code

                triples.push(
                    triple(
                        subject,
                        property_to_uri(context, i),
                        '"' + root[i]['@value'].replace(/"/g, '\\"') + '"',
                        root[i]['@language']
                    )
                );

            } else {
                // object
                if (root[i]['@id'] || root[i]['@type']) {

                    var id = '';
                    if (root[i]['@id']) {
                        id = root[i]['@id'];

                        // PHP JSON-LD framed creates bnodes _:b\d+
                        if (id.match(/_:b\d+/)) {
                            id = '';
                        }

                    }
                    if (id == '') {
                        id = subject + '#' + bnode();
                    }

					/*
                    triples.push(
                        triple(
                            subject,
                            property_to_uri(context, i),
                            id
                        )
                    );
                    */
                    

                    subtree(context, root[i], id);
                }
            }
        }


        if (Array.isArray(root[i])) {
            for (var j in root[i]) {
                if (isObject(root[i][j])) {

					// literal with language code
                    if (root[i][j]['@value'] && root[i][j]['@language']) {

                        triples.push(
                            triple(
                                subject,
                                property_to_uri(context, i),
                                '"' + root[i][j]['@value'].replace(/"/g, '\\"') + '"',
                                root[i][j]['@language']
                            )
                        );

                    }
                    
					// typed entity, as in DBPedia expanded JSON-LD
                    if (root[i][j]['value'] && root[i][j]['type']) {
                    	switch (root[i][j]['type']) {
                    	
                    		case 'uri':
								triples.push(
									triple(
										subject,
										property_to_uri(context, i),
										root[i][j]['value']
									)
								);                    		
                    			break;

                    		case 'literal':
                    			if (root[i][j]['lang']) {
                    				// string
									triples.push(
										triple(
											subject,
											property_to_uri(context, i),
											'"' + root[i][j]['value'].replace(/"/g, '\\"') + '"',
											root[i][j]['lang']
										)
									);                    		
                    			} else {
                    				// other datatype, e.g. integer
									triples.push(
										triple(
											subject,
											property_to_uri(context, i),
											'"' + String(root[i][j]['value']).replace(/"/g, '\\"') + '"'
											
										)
									);                    		                    			
                    			}
                    			break;
                    	
                    		default:
                    			break;
                    	}
                    }                    
                    
					// object
					if (root[i][j]['@id'] || root[i][j]['@type']) {

						var id = '';
						if (root[i][j]['@id']) {
							id = root[i][j]['@id'];

							// PHP JSON-LD framed creates bnodes _:b\d+
							if (id.match(/_:b\d+/)) {
								id = '';
							}

						}
						if (id == '') {
							id = subject + '#' + bnode();
						}

						/*
						triples.push(
							triple(
								subject,
								property_to_uri(context, i),
								id
							)
						);
						*/
						

						subtree(context, root[i][j], id);
					}

                }

                if (typeof root[i][j] === 'string') {
                    // simple literal                    
                    switch (i) {
                    
                    	case '@type':
                    		triples.push(
                    			triple(subject, 
                    			'http://www.w3.org/1999/02/22-rdf-syntax-ns#type', 
                    			property_to_uri(context, root[i][j]))
                    		);
                    		break;
                    
                    	default:
                    	    triples.push(
								triple(
									subject,
									property_to_uri(context, i),
									'"' + root[i][j].replace(/"/g, '\\"') + '"'
								)
							); 
                    		break;                   
                    }
                }
            }
        }


    }

}


//----------------------------------------------------------------------------------------
function ldjson(doc) {
  	triples=[];
  	bnode_count = 0;
  	
	var done = false;
	
	// Multiple graphs
	if (!done) {
	    if (doc.message['@graph']) {
	        for (var i in doc.message['@graph']) {
 	           subtree(doc.message['@context'], doc.message['@graph'][i], doc.message['@graph'][i]['@id']);
   	     	}
   	 		done = true;
   	 	}
    }
    
    // Default graph with @id
	if (!done) {
    	if (doc.message['@id']) {
	        subtree(doc.message['@context'], doc.message, doc.message['@id']);
	        done = true;
	    }
	    
    }

	// DBPedia-style JSON-LD
	if (!done) {
		for (var i in doc.message) {
		   subtree(null, doc.message[i], i);
		}
	    done = true;
    }
  	
    
    var index_type = 'spo';
 
    for (var i in triples) {
      switch (index_type) {
      	/*
        case 'osp':
          emit([triples[i][2], triples[i][0], triples[i][1]], 1);
          break;

        case 'ops':
          emit([triples[i][2], triples[i][1], triples[i][0]], 1);
          break;
      
        case 'pso':
          emit([triples[i][1], triples[i][0], triples[i][2]], 1);
          break;
          
        case 'pos':
          emit([triples[i][1], triples[i][2], triples[i][0]], 1);
          break;
          
        case 'sop':
          emit([triples[i][0], triples[i][2], triples[i][1]], 1);
          break;
          */
          
        case 'spo':
        default:
          //emit(triples[i], 1);
          console.log(JSON.stringify(triples[i], null, 2));
          break;
      }
    }
}

//----------------------------------------------------------------------------------------
function message(doc) {

	var use_roles = true;
	var use_citations = true;

	var jsonld = {};

	// context
	jsonld['@context'] = 'http://schema.org/';

	var container = null;

	// identifier
	if (doc.message.DOI) {
		jsonld['@id'] = 'https://doi.org/' + doc.message.DOI.toLowerCase();
	}

	for (var i in doc.message) {

		switch (i) {

			case 'type':
				switch (doc.message[i]) {
					case 'article-journal':
					case 'journal-article':
						jsonld['@type'] = 'ScholarlyArticle';
						break;
					default:
						break;
				}
				break;
				
			case 'DOI':
				var identifier = {};
				identifier['@type'] = 'PropertyValue';
				identifier.propertyID = 'doi';
				identifier.value = doc.message[i].toLowerCase();
				
				if (!jsonld.identifier) {
					jsonld.identifier = [];
				}
				jsonld.identifier.push(identifier);
				break;	

			case 'volume':
				jsonld.volumeNumber = doc.message[i];
				break;

			case 'issue':
				jsonld.issueNumber = doc.message[i];
				break;

			case 'URL':
				jsonld.url = doc.message[i];
				break;

			case 'page':
			case 'pages':
				var parts = doc.message[i].match(/^(.*)\-(.*)$/);
				if (parts) {
					jsonld.pageStart = parts[1];
					jsonld.pageEnd = parts[2];
				} else {
					jsonld.pagination = doc.message[i];
				}

				break;

			case 'issued':
				var date = '';
				var dateparts = doc.message[i]['date-parts'][0];

				switch (dateparts.length) {
					case 1:
						date = dateparts[0];
						break;
					case 2:
						date = dateparts[0] + '-' + ("00" + dateparts[1]).slice(-2) + '-00';
						break;
					case 3:
						date = dateparts[0] + '-' + ("00" + dateparts[1]).slice(-2) + '-' + ("00" + dateparts[2]).slice(-2);
						break;
					default:
						break;
				}
				jsonld.datePublished = date.toString();
				break;

				// tags
			case 'subject':
				jsonld.keywords = [];
				for (var j in doc.message[i]) {
					jsonld.keywords.push(doc.message[i][j]);
				}
				break;

			case 'ISSN':
				if (!container) {
					container = {};
					container['@type'] = 'Periodical';
				}

				if (!container.issn) {
					container.issn = [];
				}

				for (var j in doc.message[i]) {
					container.issn.push(doc.message[i][j]);
				}

				container['@id'] = 'http://worldcat.org/issn/' + container.issn[0];
				break;

				// journal			
			case 'container-title':
				if (!container) {
					container = {};
					container['@type'] = 'Periodical';
				}

				// journal name can be string or array
				if (Array.isArray(doc.message[i])) {

					var n = doc.message[i].length;

					if (n > 1) {
						container.name = [];
					}

					for (var j in doc.message[i]) {

						var lang = detect_language(doc.message[i][j]);

						if (lang) {
							var s = {};
							s['@lang'] = lang;
							s['@value'] = doc.message[i][j];

							if (n > 1) {
								container.name.push(s);
							} else {
								container.name = s;
							}
						} else {

							if (n > 1) {
								container.name.push(doc.message[i][j]);
							} else {
								container.name = doc.message[i][j];
							}
						}
					}
				} else {
					// string
					container.name = doc.message[i];
				}
				break;

				// title can be string or array
			case 'title':
				if (Array.isArray(doc.message[i])) {

					var n = doc.message[i].length;

					if (n > 1) {
						jsonld.name = [];
					}

					for (var j in doc.message[i]) {

						var lang = detect_language(doc.message[i][j]);

						if (lang) {
							var s = {};
							s['@lang'] = lang;
							s['@value'] = doc.message[i][j];

							if (n > 1) {
								jsonld.name.push(s);
							} else {
								jsonld.name = s;
							}
						} else {

							if (n > 1) {
								jsonld.name.push(doc.message[i][j]);
							} else {
								jsonld.name = doc.message[i][j];
							}
						}

					}
				} else {
					jsonld.name = doc.message[i];
				}
				break;


			case 'author':
				var n = doc.message[i].length;

				jsonld.creator = [];

				for (var j = 0; j < n; j++) {
					var author_id = '';

					// use ORCID if available, otherwise hash
					if (doc.message[i][j].ORCID) {
						author_id = doc.message[i][j].ORCID;
						author_id = author_id.replace(/http:/, 'https:');
					} else {
						// #hash identifier 
						author_id = jsonld['@id'] + '#author_' + (j + 1);
					}

					var creator = {};
					creator['@id'] = author_id;
					creator['@type'] = 'Person';

					// name
					var name = '';
					if (doc.message[i][j].given) {
						creator.givenName = doc.message[i][j].given;
						name += doc.message[i][j].given;
					}
					if (doc.message[i][j].family) {
						creator.familyName = doc.message[i][j].family;
						name += ' ' + doc.message[i][j].family;
					}

					if (name != '') {
						creator.name = name;
					}

					if (use_roles) {
						var role_id = jsonld['@id'] + '#role' + (j + 1);
						var role = {};
						role['@id'] = role_id;
						role['@type'] = 'Role';

						role.roleName = String(j + 1);

						role.creator = creator;

						jsonld.creator.push(role);

				  } else {
						jsonld.creator.push(creator);
					}
				}
				break;

				/*
					  "reference": [
						   {
							   "key": "11192_B1",
							   "first-page": "119",
							   "article-title": "Pseudocrangonyx, a new genus of subterranean amphipods from Japan.",
							   "volume": "10",
							   "author": "Akatsuka",
							   "year": "1922",
							   "journal-title": "Annotationes Zoologicae Japonenses"
						   },
				 */
			case 'reference':
				if (use_citations) {
					jsonld.citation = [];
					var n = doc.message[i].length;
					for (var j = 0; j < n; j++) {

					   var reference_id = '';

					   var reference = {};

					   if (doc.message[i][j].DOI) {

							// DOI is id for citation
							reference_id = "https://doi.org/" + doc.message[i][j].DOI.toLowerCase();

							// DOI cleaning (sigh)
							/* Sometimes publishes make a mess of this, e.g. 
							http://dx.doi.org/10.1111/j.1096-0031.2007.00176.x
							{
							  key: "b129_103",
							  DOI: "10.1636/H05-14 SC.1",
							  doi-asserted-by: "publisher"
							}
							*/
							reference_id = reference_id.replace(/sc.1?/g, '');
							reference_id = reference_id.replace(/\s/g, '');

							// Add DOI as identifier (to do)
							var identifier = {};
							identifier['@type'] = 'PropertyValue';
							identifier.propertyID = 'doi';
							identifier.value = doc.message[i][j].DOI.toLowerCase();
				
							if (!reference.identifier) {
								reference.identifier = [];
							}
							reference.identifier.push(identifier);							

						} else {
							// No (known) DOI for cited work

							// identifier for cited reference
							var key = doc.message[i][j].key;

							key = key.replace(/\t/g, '');
							key = key.replace(/\n/g, '');

							// replace characters not allowed
							key = key.replace(/\|/g, '-');
							key = key.replace(/\//g, '-');
							key = key.replace(/\./g, '-');
							key = key.replace(/\s/g, '-');

							reference_id = jsonld['@id'] + "/reference" + "#" + key;
						}

						reference['@id'] = reference_id;
						reference['@type'] = 'CreativeWork';

						var reference_container = null;

						// add semi-structured data if we have it
						for (var k in doc.message[i][j]) {
							switch (k) {
								case 'article-title':
									reference.name = doc.message[i][j][k];
									break;

								case 'author':
									reference.creator = doc.message[i][j][k];
									break;

								case 'first-page':
									reference.pageStart = doc.message[i][j][k];
									break;
									
								case 'ISSN':
									var issn = doc.message[i][j][k];
									issn = issn.replace('http://id.crossref.org/issn/', '');

									if (!reference_container) {
										reference_container = {};
										reference_container['@type'] = 'Periodical';
									}
								
									if (!reference_container.issn) {
										reference_container.issn = [];
										reference_container['@id'] = 'http://worldcat.org/issn/' + issn;
									}
									reference_container.issn.push(issn);
									break;
									
								case 'issue':
									reference.issueNumber = doc.message[i][j][k];
									break;

									// Journal
								case 'journal-title':
									if (!reference_container) {
										reference_container = {};
										reference_container['@type'] = 'Periodical';
										reference_container.name = doc.message[i][j][k];

										if (!reference_container['@id']) {
											reference_container['@id'] = reference['@id'] + '_container';
										}
									}
									break;
									
									// Book
								case 'volume-title':
									if (!reference_container) {
										reference_container = {};
										reference_container['@type'] = 'CreativeWork';
										reference_container.name = doc.message[i][j][k];

										if (!reference_container['@id']) {
											reference_container['@id'] = reference['@id'] + '_container';
										}
									}
									break;

								case 'unstructured':
									reference.name = doc.message[i][j][k];
									break;

								case 'volume':
									reference.volumeNumber = doc.message[i][j][k];
									break;

								case 'year':
									reference.datePublished = doc.message[i][j][k];
									reference.datePublished = reference.datePublished.replace(/[a-z]$/, '');
									break;

								default:
									break;
							}
						}

						if (reference_container) {
							reference.isPartOf = reference_container;
						}

						jsonld.citation.push(reference);
					}
				}
				break;

			default:
				break;
		}
	}

	if (container) {
		jsonld.isPartOf = container;
	}


  return jsonld;
}

//----------------------------------------------------------------------------------------
function couchdb(doc) {
	if (doc['message-format']) {

    	// JSON-LD
    	if (doc['message-format'] === 'application/ld+json') {
      		ldjson(doc);
    	}
    	
    	// CrossRef CSL    	
 	    if (doc['message-format'] == 'application/vnd.crossref-api-message+json') {
	    	// convert CSL-JSON to JSON-LD, then process
	        var d = {};
	        d.message = message(doc);
	        
	       ldjson(d);
	     }
   	
    	// CSL-JSON
	    if (doc['message-format'] == 'application/vnd.citationstyles.csl+json') {
	    	// convert CSL-JSON to JSON-LD, then process
	        var d = {};
	        d.message = message(doc);
	        
	       ldjson(d);
	     }
	         	
    }
}	


// END COUCHDB VIEW	

		
//----------------------------------------------------------------------------------------
function convert() {
	var json = $('#json').val();
	var doc = JSON.parse(json);
	
	//console.log(JSON.stringify(doc, null, 2));
	
	couchdb(doc);
}

	
	</script>		
			

</div>
</body>
</html>			