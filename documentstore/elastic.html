<html>
	<head>
		<title>JSON-LD or CSL to Elastic</title>
		<meta charset="UTF-8"/>
		<script src="jquery.js"></script>
		<!-- stuff below needs to go into CouchDB views -->
		<!-- <script src="language.js"></script> -->
		<style>
		td { border: 1px solid red; }
		</style>
	</head>
<body>

<h1>ORCID work DOI to author role</h1>

<div>
	<div style="width:100%;height:auto;">
		<h2>JSON</h2>
		
<!--

{
  "message-format": "application/vnd.citationstyles.csl+json",
  "message": {
    "id": "EWART_2015",
    "type": "article-journal",
    "author": [
      {
        "family": "EWART",
        "given": "A.",
        "literal": "A. EWART"
      },
      {
        "family": "POPPLE",
        "given": "L.W.",
        "literal": "L.W. POPPLE",
        "ORCID": "0000-0001-8630-3114"
      },
      {
        "family": "MARSHALL",
        "given": "D.C.",
        "literal": "D.C. MARSHALL"
      }
    ],
    "event-date": {
      "date-parts": [
        [
          2015,
          8
        ]
      ]
    },
    "issued": {
      "date-parts": [
        [
          2015,
          8
        ]
      ]
    },
    "collection-title": "Zootaxa",
    "container-title": "Zootaxa",
    "DOI": "10.11646/zootaxa.4001.1.1",
    "issue": "1",
    "number": "1",
    "number-of-pages": "1",
    "page": "1",
    "page-first": "1",
    "publisher": "Magnolia Press",
    "title": "<strong>New species of <em>Simona</em> Moulds, 2012 and <em>Chelapsalta</em> Moulds, 2012 cicadas (Cicadidae: Cicadettinae: Cicadettini) from Australia: comparative morphology, songs, behaviour and distributions</strong>",
    "URL": "https://doi.org/10.11646%2Fzootaxa.4001.1.1",
    "volume": "4001"
  }
}


			{
  "_id": "https://zenodo.org/record/918933",
  "_rev": "8-325d8293aa77684f08f650fd355e6300",
  "message-timestamp": "2019-01-11T17:03:02+00:00",
  "message-modified": "2019-01-11T17:03:07+00:00",
  "message-format": "application/ld+json",
  "message-source": "https://zenodo.org/api/records/918933",
  "message": {
    "@context": "http://schema.org/",
    "@id": "https://doi.org/10.3897/phytokeys.3.1131.figure1",
    "@type": "ImageObject",
    "creator": [
      {
        "@type": "Person",
        "affiliation": "Smithsonian Institution, Washington, DC, United States of America",
        "name": "Robinson, Harold"
      },
      {
        "@type": "Person",
        "affiliation": "Smithsonian Institution, Washington DC, United States of America",
        "name": "Funk, Vicki"
      }
    ],
    "datePublished": "2011-05-30",
    "description": "Figure 1 -  Nothovernonia purpurea (Sch.Bip. ex Walp.) H. Rob. and V.A. Funk: habit. [Illustration by Alice Tangerini (US)]",
    "identifier": "https://doi.org/10.3897/phytokeys.3.1131.figure1",
    "isPartOf": [
      {
        "@id": "https://doi.org/10.3897/phytokeys.3.1131",
        "@type": "CreativeWork"
      }
    ],
    "keywords": [
      "Plantae",
      "Tracheophyta",
      "Magnoliopsida",
      "Asterales",
      "Asteraceae",
      "Nothovernonia",
      "Nothovernonia purpurea",
      "Compositae",
      "Nothovernonia",
      "new genus",
      "tropical Africa",
      "Centrapalinae",
      "Erlangineae",
      "phylogeny"
    ],
    "license": "http://creativecommons.org/licenses/by/4.0/legalcode",
    "name": "Figure 1 from: Funk V, Robinson H (2011) A new genus, Nothovernonia, from tropical Africa (Asteraceae or Compositae: Vernonieae). PhytoKeys 3: 21-34. https://doi.org/10.3897/phytokeys.3.1131",
    "url": "https://zenodo.org/record/918933",
    "contentUrl": "https://zenodo.org/api/files/cfa06568-f61b-4235-8699-a189782a8bc2/oo_9863.jpg",
    "thumbnailUrl": "https://zenodo.org/api/iiif/v2/cfa06568-f61b-4235-8699-a189782a8bc2:17838d2b-2b61-4bc6-aaeb-09836c4df6f9:oo_9863.jpg/full/250,/0/default.jpg"
  }
}

-->		
		
		
		
			<!-- JSON for data object goes below -->
			<textarea id="json" style="width:100%;background-color:#224FBC;color:#FFFF66;" rows="20">{
  "_id": "http://data.rbge.org.uk/herb/E00155121",
  "_rev": "2-edc713952c2e51a10bf8aa094bfc17c7",
  "message-timestamp": "2019-01-27T16:29:19+00:00",
  "message-modified": "2019-01-27T16:29:20+00:00",
  "message-format": "application/ld+json",
  "message-source": "http://data.rbge.org.uk/herb/E00155121.rdf",
  "message": {
    "@context": {
      "@vocab": "http://rs.tdwg.org/dwc/terms/",
      "dcterms": "http://purl.org/dc/terms/",
      "rdfs": "http://www.w3.org/TR/2014/REC-rdf-schema-20140225/",
      "foaf": "http://xmlns.com/foaf/spec/",
      "ma": "https://www.w3.org/ns/ma-ont#",
      "geo": "http://www.w3.org/2003/01/geo/wgs84_pos#"
    },
    "@graph": [
      {
        "@id": "https://data.rbge.org.uk/herb/E00155121",
        "dcterms:created": "1984-07-02",
        "dcterms:creator": "A. Weber & S. Anthonysamy",
        "dcterms:description": "A herbarium specimen of Ridleyandra porphyrantha (A.Weber & R.Kiew) A.Weber collected by A. Weber & S. Anthonysamy #840711-1/3 ",
        "dcterms:modified": "2007-12-04 00:00:00",
        "dcterms:publisher": {
          "@id": "http://www.rbge.org.uk"
        },
        "dcterms:relation": {
          "@id": "https://data.rbge.org.uk/images/71403"
        },
        "dcterms:title": "A. Weber & S. Anthonysamy #840711-1/3 Ridleyandra porphyrantha (A.Weber & R.Kiew) A.Weber",
        "dcterms:type": "Specimen",
        "associatedMedia": {
          "@id": "https://data.rbge.org.uk/images/71403"
        },
        "basisOfRecord": "Specimen",
        "catalogNumber": "E00155121",
        "collectionCode": "E",
        "country": "MY",
        "countryCode": "MY",
        "earliestDateCollected": "1984-07-02",
        "family": "Gesneriaceae",
        "genus": "Ridleyandra",
        "higherGeography": "Malay Peninsula",
        "institutionCode": "http://biocol.org/urn:lsid:biocol.org:col:15670",
        "locality": "Selangor, G. Bunga Buah, on ridge E of summit",
        "maximumElevationInMeters": "1400",
        "minimumElevationInMeters": "1300",
        "recordNumber": "840711-1/3",
        "recordedBy": "A. Weber & S. Anthonysamy",
        "sampleID": "http://data.rbge.org.uk/herb/E00155121",
        "scientificName": "Ridleyandra porphyrantha (A.Weber & R.Kiew) A.Weber",
        "specificEpithet": "porphyrantha",
        "stateProvince": "Selangor",
        "http://www.w3.org/2002/07/owl#sameAs": {
          "@id": "http://data.rbge.org.uk/herb/E00155121"
        }
      },
      {
        "@id": "https://data.rbge.org.uk/images/71403",
        "dcterms:created": "2010-03-04T18:23:20Z",
        "dcterms:description": {
          "@language": "en",
          "@value": "Image of herbarium specimen"
        },
        "dcterms:format": "image/jpeg",
        "dcterms:identifier": {
          "@id": "https://data.rbge.org.uk/images/71403"
        },
        "dcterms:subject": {
          "@id": "http://data.rbge.org.uk/herb/E00155121"
        },
        "dcterms:type": {
          "@id": "http://purl.org/dc/dcmitype/Image"
        }
      },
      {
        "@id": "https://data.rbge.org.uk:443/service/rdf/herb.php?guid=http://data.rbge.org.uk/herb/E00155121",
        "dcterms:created": "2019-01-27T16:28:35+00:00",
        "dcterms:creator": "Simple PHP RDF Script",
        "dcterms:hasVersion": [
          {
            "@id": "https://data.rbge.org.uk/search/herbarium?cfg=fulldetails.cfg&specimen_num=E00155121"
          },
          {
            "@id": "http://plants.jstor.org/specimen/e00155121"
          }
        ]
      }
    ]
  }
}</textarea>
			<br />
			<button onclick="convert()">Convert JSON to JSON-LD</button>
	</div>
	<div style="clear:both;"></div>
	
	<div style="width:100%;">
		<h2>JSON-LD</h2>
		<div id="jsonld" style="width:100%;white-space:pre;background-color:#333;color:white;overflow:auto;"></div>

</div>			
			
		
		
		
<script>
	
//----------------------------------------------------------------------------------------
// START COUCHDB VIEW

var bnode_count = 0;

var elastic_search_doc = {};

//----------------------------------------------------------------------------------------
function bnode() {
	bnode_count++;
	
	return 'b' + bnode_count;
}

//----------------------------------------------------------------------------------------
// http://stackoverflow.com/a/25715455
function isObject(item) {
    return (typeof item === "object" && !Array.isArray(item) && item !== null);
}

//----------------------------------------------------------------------------------------
// http://stackoverflow.com/a/21445415
function uniques(arr) {
    var a = [];
    for (var i = 0, l = arr.length; i < l; i++)
        if (a.indexOf(arr[i]) === -1 && arr[i] !== '')
            a.push(arr[i]);
    return a;
}

//----------------------------------------------------------------------------------------
function detect_language(s) {
    var language = null;
    var matched = 0;
    var parts = [];

    var regexp = [];

    // https://gist.github.com/ryanmcgrath/982242
    regexp['ja'] = /[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g;
    // http://hjzhao.blogspot.co.uk/2015/09/javascript-detect-chinese-character.html
    regexp['zh'] = /[\u4E00-\uFA29]/g;
    // http://stackoverflow.com/questions/32709687/js-check-if-string-contains-only-cyrillic-symbols-and-spaces
    regexp['ru'] = /[\u0400-\u04FF]/g;

    for (var i in regexp) {
        parts = s.match(regexp[i]);

        if (parts != null) {
            if (parts.length > matched) {
                language = i;
                matched = parts.length;
            }
        }
    }

    // require a minimum matching
    if (matched < 2) {
        language = null;
    }

    return language;
}


//----------------------------------------------------------------------------------------
function property_to_uri(context, property) {
    var uri = property;
    
	if (context) {
		var m = property.match(/([a-z]+):([a-z]+)/i);
		if (m) {
			if (context[m[1]]) {
				uri = context[m[1]] + m[2];
			}
		} else {
			if (context['@vocab']) {
				uri = context['@vocab'] + property;
			} else {
				if (typeof context === 'string') {
					uri = context + property;
				}
			}
		}
	}

    return uri;
}

//----------------------------------------------------------------------------------------
function add_to_elastic(subject, key, value, language) {
	var done = false;
	
	// type
	if (!done) {

		if (key == '@type') {
		
			// Is this the "main" topic of the graph?
			if (subject == elastic_search_doc.search_result_data['@id']) {
				
				elastic_search_doc.search_result_data['@type'].push(value);
			}
		
			done = true
		}
	}
	
	// CETAF	
	if (!done) {

		if (key == 'http://purl.org/dc/terms/type') {
			// Is this the "main" topic of the graph?
			if (subject == elastic_search_doc.search_result_data['@id']) {
				
				elastic_search_doc.search_result_data['@type'].push(value);
			}
		
			done = true
		}
	}		
	
	if (!done) {

		if (key == 'http://schema.org/thumbnailUrl') {
		
			// Is this the "main" topic of the graph?
			if (subject == elastic_search_doc.search_result_data['@id']) {
		
				if (!elastic_search_doc.search_result_data.image) {
					elastic_search_doc.search_result_data.image = {};
				}
				elastic_search_doc.search_result_data.image.thumbnailUrl = value;
			}
		
			done = true
		}
	}

	if (!done) {

		if (key == 'http://schema.org/contentUrl') {
		
			// Is this the "main" topic of the graph?
			if (subject == elastic_search_doc.search_result_data['@id']) {
		
				if (!elastic_search_doc.search_result_data.image) {
					elastic_search_doc.search_result_data.image = {};
				}
				elastic_search_doc.search_result_data.image.contentUrl = value;
			}
		
			done = true
		}
	}
	

	if (!done) {

		if (key == 'http://schema.org/name') {

			console.log(subject, value);
		
			// Is this the "main" topic of the graph?
			if (subject == elastic_search_doc.search_result_data['@id']) {
		
				// yes, so store values and add to boosted search
				if (typeof language === 'undefined') {
					language = 'und';
				}
				
				elastic_search_doc.search_result_data.name[language] = value;
				elastic_search_doc.search_data.fulltext_boosted_values.push(value);
			} else {
				// just add to normal search_data
				elastic_search_doc.search_data.fulltext_values.push(value);			
			}
		
			done = true
		}
	}
	
	// CETAF
	if (!done) {

		if (key == 'http://purl.org/dc/terms/title') {

			//console.log(subject, value);
		
			// Is this the "main" topic of the graph?
			if (subject == elastic_search_doc.search_result_data['@id']) {
		
				// yes, so store values and add to boosted search
				if (typeof language === 'undefined') {
					language = 'und';
				}
				
				elastic_search_doc.search_result_data.name[language] = value;
				elastic_search_doc.search_data.fulltext_boosted_values.push(value);
			} else {
				// just add to normal search_data
				elastic_search_doc.search_data.fulltext_values.push(value);			
			}
		
			done = true
		}
	}
	
	
	if (!done) {

		if (key == 'http://schema.org/description') {

			console.log(subject, value);
		
			// Is this the "main" topic of the graph?
			if (subject == elastic_search_doc.search_result_data['@id']) {
		
				// yes, so store values and add to boosted search
				if (typeof language === 'undefined') {
					language = 'und';
				}
				
				elastic_search_doc.search_result_data.description[language] = value;
				elastic_search_doc.search_data.fulltext_boosted_values.push(value);
			} else {
				// just add to normal search_data
				elastic_search_doc.search_data.fulltext_values.push(value);			
			}
		
			done = true
		}
	}
	
	// CETAF
	if (!done) {

		if (key == 'http://purl.org/dc/terms/description') {

			// Is this the "main" topic of the graph?
			if (subject == elastic_search_doc.search_result_data['@id']) {
		
				// yes, so store values and add to boosted search
				if (typeof language === 'undefined') {
					language = 'und';
				}
				
				elastic_search_doc.search_result_data.description[language] = value;
				elastic_search_doc.search_data.fulltext_boosted_values.push(value);
			} else {
				// just add to normal search_data
				elastic_search_doc.search_data.fulltext_values.push(value);			
			}
		
			done = true
		}
	}
	
	
	if (!done) {
		console.log(subject + ': ' + key + '=' + value);
		if (elastic_search_doc.search_data.fulltext_values.indexOf(value) == -1) {
			elastic_search_doc.search_data.fulltext_values.push(value);
		}
	}



}

//----------------------------------------------------------------------------------------
function subtree(context, root, subject) {

    for (var i in root) {

        //console.log(i);

        // Simple literal
        if (typeof root[i] === 'string') {
            switch (i) {
                case '@context':
                case '@id':
                    break;

                case '@type':  
                	add_to_elastic(subject, i, root[i]);               	
                    break;

                default:
                    // simple literal
                    var key = property_to_uri(context, i);
                    var value = root[i];
                    add_to_elastic(subject, key, value); 
                    break;
            }
        }

        if (isObject(root[i])) {
            if (root[i]['@value'] && root[i]['@language']) {
                // literal with language code
                
                    var key = property_to_uri(context, i);
                    var value = root[i]['@value'];
                    var language = root[i]['@language'];
                    add_to_elastic(subject, key, value, language); 

            } else {
                // object
                if (root[i]['@id'] || root[i]['@type']) {

                    var id = '';
                    if (root[i]['@id']) {
                        id = root[i]['@id'];

                        // PHP JSON-LD framed creates bnodes _:b\d+
                        if (id.match(/_:b\d+/)) {
                            id = '';
                        }

                    }
                    if (id == '') {
                        id = subject + '#' + bnode();
                    }

                    subtree(context, root[i], id);
                }
            }
        }


        if (Array.isArray(root[i])) {
            for (var j in root[i]) {
                if (isObject(root[i][j])) {

					// literal with language code
                    if (root[i][j]['@value'] && root[i][j]['@language']) {

                    	var key = property_to_uri(context, i);
                    	var value = root[i][j]['@value'];
                    	var language = root[i][j]['@language'];
                  		add_to_elastic(subject, key, value, language); 

                    }
                    
					// typed entity, as in DBPedia expanded JSON-LD
                    if (root[i][j]['value'] && root[i][j]['type']) {
                    	switch (root[i][j]['type']) {
                    	
                    		case 'uri':
                    			break;

                    		case 'literal':
                    			if (root[i][j]['lang']) {
                    				// string
									var key = property_to_uri(context, i);
									var value = root[i][j]['@value'];
									var language = root[i][j]['@language'];
									add_to_elastic(subject, key, value, language); 
 
                    			} else {
                    				// other datatype, e.g. integer
									var key = property_to_uri(context, i);
									var value = String(root[i][j]['value']);
									add_to_elastic(subject, key, value); 
								
                   				}
                    			break;
                    	
                    		default:
                    			break;
                    	}
                    }                    
                    
					// object
					if (root[i][j]['@id'] || root[i][j]['@type']) {

						var id = '';
						if (root[i][j]['@id']) {
							id = root[i][j]['@id'];

							// PHP JSON-LD framed creates bnodes _:b\d+
							if (id.match(/_:b\d+/)) {
								id = '';
							}

						}
						if (id == '') {
							id = subject + '#' + bnode();
						}

						subtree(context, root[i][j], id);
					}

                }

                if (typeof root[i][j] === 'string') {
                    // simple literal
                    var key = property_to_uri(context, i);
                    var value = root[i][j];
					add_to_elastic(subject, key, value);                    					
                }

            }
        }


    }

}


//----------------------------------------------------------------------------------------
function ldjson(doc) {

	// output
	$('#jsonld').html('<pre>' + JSON.stringify(doc.message, null, 2) + '</pre>');
	
    elastic_search_doc = {};
    
    // we need the id for the "main" entity of this graph
    var id = '';
    
    if (id == '') {
    	if (doc.message['@id']) {
	        id = doc.message['@id'];
	    }
    }
    
    // Get @graph @id that corresponds to document as this is the "main"
    // entity, but note that we may need to handle http versus https issues
    if (id == '') {
    	if (doc.message['@graph']) {
 	        id = doc._id;
 	        
 	        for (var j in doc.message['@graph']) {
 	        	var s1 = doc.message['@graph'][j]['@id'];
 	        	var s2 = doc._id;
 	        	
 	        	s1 = s1.replace(/https?:\/\//, '');
 	        	s2 = s2.replace(/https?:\/\//, '');
 	        	
 	        	if (s1 === s2) {
 	        		id = doc.message['@graph'][j]['@id'];
 	        	} 	        	
 	        } 	        
	    }
    }

    elastic_search_doc.id = id;
    
	// output to display in list of hits
	elastic_search_doc.search_result_data = {};
	elastic_search_doc.search_result_data['@id'] = id;
	elastic_search_doc.search_result_data['@type'] = [];
	elastic_search_doc.search_result_data.name = {};
	elastic_search_doc.search_result_data.description = {};
	
	// fields that will be searched on
	elastic_search_doc.search_data = {};
	
	// text fields for searching on
	elastic_search_doc.search_data.fulltext_values = [];
	elastic_search_doc.search_data.fulltext_boosted_values = [];	
  	
	var done = false;
	
	// Multiple graphs
	if (!done) {
	    if (doc.message['@graph']) {
	        for (var i in doc.message['@graph']) {
 	           subtree(doc.message['@context'], doc.message['@graph'][i], doc.message['@graph'][i]['@id']);
   	     	}
   	 		done = true;
   	 	}
    }
    
    // Default graph with @id
	if (!done) {
    	if (doc.message['@id']) {
	        subtree(doc.message['@context'], doc.message, doc.message['@id']);
	        done = true;
	    }
    }

	// DBPedia-style JSON-LD
	if (!done) {
		for (var i in doc.message) {
		   subtree(null, doc.message[i], i);
		}
	    done = true;
    }
    
    // cleanup
	elastic_search_doc.search_data.fulltext = elastic_search_doc.search_data.fulltext_values.join(' ');
	delete elastic_search_doc.search_data.fulltext_values;

	elastic_search_doc.search_data.fulltext_boosted = elastic_search_doc.search_data.fulltext_boosted_values.join(' ');
	delete elastic_search_doc.search_data.fulltext_boosted_values;
    
    
	$('#jsonld').html('<pre>' + JSON.stringify(elastic_search_doc, null, 2) + '</pre>');
	
	//emit(doc._id, elastic_search_doc);
    

}

//----------------------------------------------------------------------------------------
function message(doc) {

	var use_roles = true;
	var use_citations = true;

	var jsonld = {};

	// context
	jsonld['@context'] = 'http://schema.org/';

	var container = null;

	// identifier
	if (doc.message.DOI) {
		jsonld['@id'] = 'https://doi.org/' + doc.message.DOI.toLowerCase();
	}

	for (var i in doc.message) {

		switch (i) {

			case 'type':
				switch (doc.message[i]) {
					case 'article-journal':
					case 'journal-article':
						jsonld['@type'] = 'ScholarlyArticle';
						break;
					default:
						break;
				}
				break;
				
			case 'DOI':
				var identifier = {};
				identifier['@type'] = 'PropertyValue';
				identifier.propertyID = 'doi';
				identifier.value = doc.message[i].toLowerCase();
				
				if (!jsonld.identifier) {
					jsonld.identifier = [];
				}
				jsonld.identifier.push(identifier);
				break;	

			case 'volume':
				jsonld.volumeNumber = doc.message[i];
				break;

			case 'issue':
				jsonld.issueNumber = doc.message[i];
				break;

			case 'URL':
				jsonld.url = doc.message[i];
				break;

			case 'page':
			case 'pages':
				var parts = doc.message[i].match(/^(.*)\-(.*)$/);
				if (parts) {
					jsonld.pageStart = parts[1];
					jsonld.pageEnd = parts[2];
				} else {
					jsonld.pagination = doc.message[i];
				}

				break;

			case 'issued':
				var date = '';
				var dateparts = doc.message[i]['date-parts'][0];

				switch (dateparts.length) {
					case 1:
						date = dateparts[0];
						break;
					case 2:
						date = dateparts[0] + '-' + ("00" + dateparts[1]).slice(-2) + '-00';
						break;
					case 3:
						date = dateparts[0] + '-' + ("00" + dateparts[1]).slice(-2) + '-' + ("00" + dateparts[2]).slice(-2);
						break;
					default:
						break;
				}
				jsonld.datePublished = date.toString();
				break;

				// tags
			case 'subject':
				jsonld.keywords = [];
				for (var j in doc.message[i]) {
					jsonld.keywords.push(doc.message[i][j]);
				}
				break;

			case 'ISSN':
				if (!container) {
					container = {};
					container['@type'] = 'Periodical';
				}

				if (!container.issn) {
					container.issn = [];
				}

				for (var j in doc.message[i]) {
					container.issn.push(doc.message[i][j]);
				}

				container['@id'] = 'http://worldcat.org/issn/' + container.issn[0];
				break;

				// journal			
			case 'container-title':
				if (!container) {
					container = {};
					container['@type'] = 'Periodical';
				}

				// journal name can be string or array
				if (Array.isArray(doc.message[i])) {

					var n = doc.message[i].length;

					if (n > 1) {
						container.name = [];
					}

					for (var j in doc.message[i]) {

						var lang = detect_language(doc.message[i][j]);

						if (lang) {
							var s = {};
							s['@lang'] = lang;
							s['@value'] = doc.message[i][j];

							if (n > 1) {
								container.name.push(s);
							} else {
								container.name = s;
							}
						} else {

							if (n > 1) {
								container.name.push(doc.message[i][j]);
							} else {
								container.name = doc.message[i][j];
							}
						}
					}
				} else {
					// string
					container.name = doc.message[i];
				}
				break;

				// title can be string or array
			case 'title':
				if (Array.isArray(doc.message[i])) {

					var n = doc.message[i].length;

					if (n > 1) {
						jsonld.name = [];
					}

					for (var j in doc.message[i]) {

						var lang = detect_language(doc.message[i][j]);

						if (lang) {
							var s = {};
							s['@lang'] = lang;
							s['@value'] = doc.message[i][j];

							if (n > 1) {
								jsonld.name.push(s);
							} else {
								jsonld.name = s;
							}
						} else {

							if (n > 1) {
								jsonld.name.push(doc.message[i][j]);
							} else {
								jsonld.name = doc.message[i][j];
							}
						}

					}
				} else {
					jsonld.name = doc.message[i];
				}
				break;


			case 'author':
				var n = doc.message[i].length;

				jsonld.creator = [];

				for (var j = 0; j < n; j++) {
					var author_id = '';

					// use ORCID if available, otherwise hash
					if (doc.message[i][j].ORCID) {
						author_id = doc.message[i][j].ORCID;
						author_id = author_id.replace(/http:/, 'https:');
					} else {
						// #hash identifier 
						author_id = jsonld['@id'] + '#author_' + (j + 1);
					}

					var creator = {};
					creator['@id'] = author_id;
					creator['@type'] = 'Person';

					// name
					var name = '';
					if (doc.message[i][j].given) {
						creator.givenName = doc.message[i][j].given;
						name += doc.message[i][j].given;
					}
					if (doc.message[i][j].family) {
						creator.familyName = doc.message[i][j].family;
						name += ' ' + doc.message[i][j].family;
					}

					if (name != '') {
						creator.name = name;
					}

					if (use_roles) {
						var role_id = jsonld['@id'] + '#role' + (j + 1);
						var role = {};
						role['@id'] = role_id;
						role['@type'] = 'Role';

						role.roleName = String(j + 1);

						role.creator = creator;

						jsonld.creator.push(role);

				  } else {
						jsonld.creator.push(creator);
					}
				}
				break;

				/*
					  "reference": [
						   {
							   "key": "11192_B1",
							   "first-page": "119",
							   "article-title": "Pseudocrangonyx, a new genus of subterranean amphipods from Japan.",
							   "volume": "10",
							   "author": "Akatsuka",
							   "year": "1922",
							   "journal-title": "Annotationes Zoologicae Japonenses"
						   },
				 */
			case 'reference':
				if (use_citations) {
					jsonld.citation = [];
					var n = doc.message[i].length;
					for (var j = 0; j < n; j++) {

					   var reference_id = '';

					   var reference = {};

					   if (doc.message[i][j].DOI) {

							// DOI is id for citation
							reference_id = "https://doi.org/" + doc.message[i][j].DOI.toLowerCase();

							// DOI cleaning (sigh)
							/* Sometimes publishes make a mess of this, e.g. 
							http://dx.doi.org/10.1111/j.1096-0031.2007.00176.x
							{
							  key: "b129_103",
							  DOI: "10.1636/H05-14 SC.1",
							  doi-asserted-by: "publisher"
							}
							*/
							reference_id = reference_id.replace(/sc.1?/g, '');
							reference_id = reference_id.replace(/\s/g, '');

							// Add DOI as identifier (to do)
							var identifier = {};
							identifier['@type'] = 'PropertyValue';
							identifier.propertyID = 'doi';
							identifier.value = doc.message[i][j].DOI.toLowerCase();
				
							if (!reference.identifier) {
								reference.identifier = [];
							}
							reference.identifier.push(identifier);							

						} else {
							// No (known) DOI for cited work

							// identifier for cited reference
							var key = doc.message[i][j].key;

							key = key.replace(/\t/g, '');
							key = key.replace(/\n/g, '');

							// replace characters not allowed
							key = key.replace(/\|/g, '-');
							key = key.replace(/\//g, '-');
							key = key.replace(/\./g, '-');
							key = key.replace(/\s/g, '-');

							reference_id = jsonld['@id'] + "/reference" + "#" + key;
						}

						reference['@id'] = reference_id;
						reference['@type'] = 'CreativeWork';

						var reference_container = null;

						// add semi-structured data if we have it
						for (var k in doc.message[i][j]) {
							switch (k) {
								case 'article-title':
									reference.name = doc.message[i][j][k];
									break;

								case 'author':
									reference.creator = doc.message[i][j][k];
									break;

								case 'first-page':
									reference.pageStart = doc.message[i][j][k];
									break;
									
								case 'ISSN':
									var issn = doc.message[i][j][k];
									issn = issn.replace('http://id.crossref.org/issn/', '');

									if (!reference_container) {
										reference_container = {};
										reference_container['@type'] = 'Periodical';
									}
								
									if (!reference_container.issn) {
										reference_container.issn = [];
										reference_container['@id'] = 'http://worldcat.org/issn/' + issn;
									}
									reference_container.issn.push(issn);
									break;
									
								case 'issue':
									reference.issueNumber = doc.message[i][j][k];
									break;

									// Journal
								case 'journal-title':
									if (!reference_container) {
										reference_container = {};
										reference_container['@type'] = 'Periodical';
										reference_container.name = doc.message[i][j][k];

										if (!reference_container['@id']) {
											reference_container['@id'] = reference['@id'] + '_container';
										}
									}
									break;
									
									// Book
								case 'volume-title':
									if (!reference_container) {
										reference_container = {};
										reference_container['@type'] = 'CreativeWork';
										reference_container.name = doc.message[i][j][k];

										if (!reference_container['@id']) {
											reference_container['@id'] = reference['@id'] + '_container';
										}
									}
									break;

								case 'unstructured':
									reference.name = doc.message[i][j][k];
									break;

								case 'volume':
									reference.volumeNumber = doc.message[i][j][k];
									break;

								case 'year':
									reference.datePublished = doc.message[i][j][k];
									reference.datePublished = reference.datePublished.replace(/[a-z]$/, '');
									break;

								default:
									break;
							}
						}

						if (reference_container) {
							reference.isPartOf = reference_container;
						}

						jsonld.citation.push(reference);
					}
				}
				break;

			default:
				break;
		}
	}

	if (container) {
		jsonld.isPartOf = container;
	}


  return jsonld;
}

//----------------------------------------------------------------------------------------
function couchdb(doc) {
	if (doc['message-format']) {

    	// JSON-LD
    	if (doc['message-format'] === 'application/ld+json') {
      		ldjson(doc);
    	}
    	
    	// CrossRef CSL    	
 	    if (doc['message-format'] == 'application/vnd.crossref-api-message+json') {
	    	// convert CSL-JSON to JSON-LD, then process
	        var d = {};
	        d._id = doc._id;
	        d.message = message(doc);
	        
	       ldjson(d);
	     }
   	
    	// CSL-JSON
	    if (doc['message-format'] == 'application/vnd.citationstyles.csl+json') {
	    	// convert CSL-JSON to JSON-LD, then process
	        var d = {};
	        d._id = doc._id;
	        d.message = message(doc);
	        
	       ldjson(d);
	     }
	         	
    }
}	


// END COUCHDB VIEW	
//----------------------------------------------------------------------------------------



		
//----------------------------------------------------------------------------------------
function convert() {
	var json = $('#json').val();
	var doc = JSON.parse(json);
	
	//console.log(JSON.stringify(doc, null, 2));
	
	couchdb(doc);
}

	
	</script>		
			

</div>
</body>
</html>			